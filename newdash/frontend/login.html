<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPFBL Dashboard - Login</title>
    <link rel="stylesheet" href="login.css">
    <script src="version.js" defer></script>
    <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="login-header">
                <img src="/logo.png" alt="Logo SPFBL" style="max-width:280px;max-height:60px;width:auto;height:auto;margin-bottom:1rem;">
                <p>Painel Administrativo</p>
            </div>

            <!-- Tela de Login Normal -->
            <form id="login-form" onsubmit="handleLogin(event)" style="display: block;">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        autocomplete="email"
                        placeholder="usuario@dominio.com"
                        maxlength="255"
                        onblur="checkUserStatus(this.value)"
                    >
                </div>

                <div class="form-group">
                    <label for="password">Senha ou código TOTP</label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        autocomplete="current-password"
                        placeholder="Sua senha ou código TOTP (6 dígitos)"
                        maxlength="128"
                    >
                </div>

                <div id="error-message" class="error-message" style="display: none;"></div>

                <button type="submit" id="login-btn" class="login-btn">
                    Entrar
                </button>
            </form>

            <!-- Tela de Primeiro Acesso (TOTP) -->
            <div id="first-access-form" style="display: none;">
                <div class="info-box">
                    <p class="info-title">Seu e-mail ainda não possui TOTP cadastrado</p>
                    <p class="info-text">Peça o código pelo botão abaixo e depois digite-o no campo "Senha ou código TOTP" para entrar.</p>
                </div>

                <input type="hidden" id="totp-email" name="totp-email">

                <div id="error-message-totp" class="error-message" style="display: none;"></div>

                <!-- reCAPTCHA v3 (invisível) ou v2 (visível) -->
                <div id="recaptcha-container" class="recaptcha-container">
                    <div class="g-recaptcha" data-sitekey="" id="recaptcha-widget"></div>
                </div>

                <button type="button" id="send-totp-btn" class="login-btn totp-btn" onclick="handleSendTOTP()">
                    Enviar TOTP por Email
                </button>

                <button type="button" class="login-btn back-btn" onclick="backToLogin()">
                    Ocultar reenvio de código
                </button>

                <p class="help-text">
                    Essa etapa não bloqueia o login. Basta solicitar o código e informá-lo no campo de senha/código TOTP.
                </p>
            </div>

            <div class="login-footer">
                <p class="version-info">SPFBL Dashboard <span data-dashboard-version>v0.00</span></p>
            </div>
        </div>

        <div class="background-animation">
            <div class="circle circle-1"></div>
            <div class="circle circle-2"></div>
            <div class="circle circle-3"></div>
        </div>
    </div>

    <script>
        // Configuração do reCAPTCHA (carregada do servidor)
        let RECAPTCHA_SITE_KEY = '';
        let RECAPTCHA_ENABLED = false;
        let recaptchaReady = false;

        // Callback chamado quando o reCAPTCHA estiver pronto
        function onRecaptchaLoad() {
            recaptchaReady = true;
            renderRecaptchaWidget();
        }

        // Renderizar widget do reCAPTCHA
        function renderRecaptchaWidget() {
            // Verificar se reCAPTCHA está habilitado
            if (!RECAPTCHA_ENABLED || !RECAPTCHA_SITE_KEY) {
                console.log('reCAPTCHA: Desabilitado ou sem chave');
                return;
            }

            const recaptchaWidget = document.getElementById('recaptcha-widget');
            const recaptchaContainer = document.getElementById('recaptcha-container');

            // Verificar se o grecaptcha está disponível
            if (typeof grecaptcha === 'undefined' || !grecaptcha.render) {
                console.log('reCAPTCHA: Script do Google ainda não carregou, tentando novamente em 500ms...');
                // Tentar novamente após 500ms
                setTimeout(renderRecaptchaWidget, 500);
                return;
            }

            if (recaptchaWidget) {
                try {
                    // Verificar se já foi renderizado
                    if (recaptchaWidget.innerHTML.trim() === '' || !recaptchaWidget.querySelector('iframe')) {
                        console.log('reCAPTCHA: Renderizando widget com chave:', RECAPTCHA_SITE_KEY.substring(0, 20) + '...');
                        grecaptcha.render('recaptcha-widget', {
                            'sitekey': RECAPTCHA_SITE_KEY
                        });
                        if (recaptchaContainer) {
                            recaptchaContainer.style.display = 'block';
                            console.log('reCAPTCHA: Widget renderizado e visível');
                        }
                    } else {
                        console.log('reCAPTCHA: Widget já renderizado, apenas exibindo');
                        if (recaptchaContainer) {
                            recaptchaContainer.style.display = 'block';
                        }
                    }
                } catch (e) {
                    console.error('reCAPTCHA: Erro ao renderizar:', e.message);
                }
            } else {
                console.error('reCAPTCHA: Elemento recaptcha-widget não encontrado');
            }
        }

        // Carregar configuração de reCAPTCHA do servidor
        async function loadRecaptchaConfig() {
            try {
                // Buscar configuração do endpoint do backend
                const response = await fetch('/api/config/recaptcha');
                if (response.ok) {
                    const config = await response.json();
                    RECAPTCHA_ENABLED = config.enabled;
                    RECAPTCHA_SITE_KEY = config.site_key;

                    if (RECAPTCHA_ENABLED && RECAPTCHA_SITE_KEY) {
                        // Configurar widget v2 (checkbox visível)
                        const recaptchaWidget = document.getElementById('recaptcha-widget');
                        if (recaptchaWidget) {
                            recaptchaWidget.setAttribute('data-sitekey', RECAPTCHA_SITE_KEY);
                        }

                        // Tentar renderizar (se grecaptcha já estiver carregado)
                        if (typeof grecaptcha !== 'undefined' && grecaptcha.render) {
                            recaptchaReady = true;
                            renderRecaptchaWidget();
                        }
                        // Caso contrário, onRecaptchaLoad() será chamado quando carregar
                    } else {
                        // reCAPTCHA desabilitado, ocultar container
                        const recaptchaContainer = document.getElementById('recaptcha-container');
                        if (recaptchaContainer) {
                            recaptchaContainer.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading reCAPTCHA config:', error);
                // Se falhar, assumir que reCAPTCHA está desabilitado
                RECAPTCHA_ENABLED = false;
                const recaptchaContainer = document.getElementById('recaptcha-container');
                if (recaptchaContainer) {
                    recaptchaContainer.style.display = 'none';
                }
            }
        }

        function onRecaptchaSuccess() {
            // reCAPTCHA resolvido com sucesso
            document.getElementById('send-totp-btn').disabled = false;
        }

        async function handleLogin(event) {
            event.preventDefault();

            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const errorDiv = document.getElementById('error-message');
            const loginBtn = document.getElementById('login-btn');

            // Limpar mensagem de erro anterior
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';

            // Sanitizar inputs
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            // Validação básica
            if (!email || !password) {
                showError('Por favor, preencha email e senha ou código TOTP');
                return;
            }

            // Validar formato de email
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(email)) {
                showError('Formato de email inválido');
                return;
            }

            // Desabilitar botão durante requisição
            loginBtn.disabled = true;
            loginBtn.textContent = 'Entrando...';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Login bem-sucedido
                    showSuccess('Login realizado com sucesso! Redirecionando...');

                    // Limpar campos
                    emailInput.value = '';
                    passwordInput.value = '';

                    // Redirecionar para dashboard
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 1000);
                } else {
                    // Login falhou
                    let errorMsg = data.error || 'Credenciais inválidas';

                    if (data.remaining_attempts !== undefined) {
                        errorMsg += ` (${data.remaining_attempts} tentativas restantes)`;
                    }

                    if (response.status === 429) {
                        errorMsg = 'Muitas tentativas de login. Tente novamente mais tarde.';
                    }

                    showError(errorMsg);

                    // Limpar senha
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            } catch (error) {
                showError('Erro ao conectar ao servidor. Tente novamente.');
                console.error('Login error:', error);
            } finally {
                // Reabilitar botão
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar';
            }
        }

        async function checkUserStatus(email) {
            if (!email || email.trim() === '') {
                return;
            }

            try {
                const response = await fetch(`/api/user/check-status?email=${encodeURIComponent(email)}`);
                const data = await response.json();

                if (response.ok && data.success) {
                    if (!data.has_totp) {
                        // Usuário não tem TOTP, mostrar tela de primeiro acesso
                        showFirstAccessForm(email);
                    } else {
                        hideFirstAccessForm();
                    }
                }
            } catch (error) {
                console.error('Error checking user status:', error);
                // Silenciosamente ignorar erros de verificação
            }
        }

        function showFirstAccessForm(email) {
            const totpForm = document.getElementById('first-access-form');
            document.getElementById('login-form').style.display = 'block';
            totpForm.style.display = 'block';
            document.getElementById('totp-email').value = email;

            // Renderizar reCAPTCHA quando o modal for exibido
            if (RECAPTCHA_ENABLED && RECAPTCHA_SITE_KEY) {
                // Aguardar um pouco para garantir que o modal está visível
                setTimeout(() => {
                    renderRecaptchaWidget();
                }, 100);
            } else {
                // reCAPTCHA desabilitado, ocultar container
                const recaptchaContainer = document.getElementById('recaptcha-container');
                if (recaptchaContainer) {
                    recaptchaContainer.style.display = 'none';
                }
            }
        }

        function backToLogin() {
            document.getElementById('first-access-form').style.display = 'none';
            document.getElementById('email').value = document.getElementById('totp-email').value;
            document.getElementById('password').focus();
        }

        function hideFirstAccessForm() {
            document.getElementById('first-access-form').style.display = 'none';
        }

        async function handleSendTOTP() {
            const email = document.getElementById('totp-email').value;
            const errorDiv = document.getElementById('error-message-totp');
            const sendBtn = document.getElementById('send-totp-btn');

            errorDiv.style.display = 'none';
            errorDiv.textContent = '';

            if (!email) {
                showErrorTotp('Email não fornecido');
                return;
            }

            // Obter token do reCAPTCHA v2 (somente se habilitado)
            let recaptchaToken = '';
            if (RECAPTCHA_ENABLED && RECAPTCHA_SITE_KEY) {
                // reCAPTCHA está habilitado, obter resposta do widget v2
                if (window.grecaptcha) {
                    try {
                        recaptchaToken = grecaptcha.getResponse();
                    } catch (error) {
                        console.error('Error getting reCAPTCHA token:', error);
                    }
                }

                if (!recaptchaToken) {
                    showErrorTotp('Por favor, complete o reCAPTCHA marcando a caixa "Não sou um robô"');
                    return;
                }
            }
            // Se reCAPTCHA não está habilitado, recaptchaToken fica vazio e backend permite

            sendBtn.disabled = true;
            sendBtn.textContent = 'Enviando...';

            try {
                const response = await fetch('/api/user/request-totp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: email,
                        recaptcha_token: recaptchaToken
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccessTotp(data.message || 'TOTP enviado com sucesso! Verifique seu email.');
                    showSuccess('Código enviado. Digite o TOTP recebido no campo "Senha ou código TOTP".');
                    document.getElementById('password').focus();
                } else {
                    showErrorTotp(data.error || 'Erro ao enviar TOTP');
                }
            } catch (error) {
                showErrorTotp('Erro ao enviar TOTP. Tente novamente.');
                console.error('Send TOTP error:', error);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Enviar TOTP por Email';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.className = 'error-message error';
        }

        function showErrorTotp(message) {
            const errorDiv = document.getElementById('error-message-totp');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.className = 'error-message error';
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.className = 'error-message success';
        }

        function showSuccessTotp(message) {
            const errorDiv = document.getElementById('error-message-totp');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.className = 'error-message success';
        }

        // Verificar se já está autenticado
        window.addEventListener('DOMContentLoaded', async () => {
            // Carregar configuração de reCAPTCHA
            loadRecaptchaConfig();

            try {
                const response = await fetch('/api/user', {
                    credentials: 'include'
                });

                if (response.ok) {
                    // Já está autenticado, redirecionar
                    window.location.href = '/dashboard.html';
                }
            } catch (error) {
                // Ignorar erro - usuário não está autenticado
            }
        });

        // Prevenir ataques de força bruta com delay
        let loginAttempts = 0;
        const originalSubmit = handleLogin;

        function rateLimitedLogin(event) {
            if (loginAttempts > 3) {
                const delay = Math.min(loginAttempts * 1000, 10000);
                showError(`Aguarde ${delay / 1000} segundos antes de tentar novamente`);
                setTimeout(() => {
                    loginAttempts = 0;
                }, delay);
                event.preventDefault();
                return;
            }

            loginAttempts++;
            originalSubmit(event);
        }
    </script>
</body>
</html>
